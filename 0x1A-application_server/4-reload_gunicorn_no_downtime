#!/usr/bin/env bash
#script to reload Gunicorn in a graceful way.

# Ensure script is run as root (for systemd control)
if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root" 
  exit 1
fi

# Find all Gunicorn worker PIDs
worker_pids=($(pgrep -f "gunicorn worker"))

# Reload Gunicorn master (sends HUP signal)
sudo systemctl reload gunicorn

# Wait for old workers to finish (adjust timeout as needed)
timeout=60
end_time=$((SECONDS + timeout))
while [[ ${#worker_pids[@]} -gt 0 && SECONDS -lt $end_time ]]; do
  echo "Waiting for old workers to finish..."
  sleep 1

  # Remove finished worker PIDs from the list
  for pid in "${worker_pids[@]}"; do
    if ! kill -0 "$pid" 2>/dev/null; then
      worker_pids=(${worker_pids[@]/"$pid"})
    fi
  done
done

if [[ ${#worker_pids[@]} -gt 0 ]]; then
  echo "Timeout exceeded. Some workers did not exit gracefully."
fi
